<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Manage Plan - Fitness Tracker</title>
    <link rel="stylesheet" href="edit-workouts-style.css">
    <link rel="icon" href="images/eagle.png" type="image/png">
</head>
<body>
    <div id="toast-container"></div>
    <svg style="display: none;">
        <symbol id="icon-close" viewBox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></symbol>
        <symbol id="icon-share" viewBox="0 0 24 24" fill="none">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
        </symbol>
        <symbol id="icon-cancel-circle-sharp" viewBox="0 0 24 24" fill="none">
            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke-width="1.5"/>
            <path d="M14.5 9.5L9.5 14.5" stroke-width="1.5" stroke-linecap="sharp"/>
            <path d="M9.5 9.5L14.5 14.5" stroke-width="1.5" stroke-linecap="sharp"/>
        </symbol>
        <symbol id="icon-file-import" viewBox="0 0 24 24" fill="currentColor">
            <path fill-rule="evenodd" d="M5.625 1.5H9a3.75 3.75 0 0 1 3.75 3.75v1.875c0 1.036.84 1.875 1.875 1.875H16.5a3.75 3.75 0 0 1 3.75 3.75v7.875c0 1.035-.84 1.875-1.875 1.875H5.625a1.875 1.875 0 0 1-1.875-1.875V3.375c0-1.036.84-1.875 1.875-1.875Zm5.845 17.03a.75.75 0 0 0 1.06 0l3-3a.75.75 0 1 0-1.06-1.06l-1.72 1.72V12a.75.75 0 0 0-1.5 0v4.19l-1.72-1.72a.75.75 0 0 0-1.06 1.06l3 3Z" clip-rule="evenodd" />
            <path d="M14.25 5.25a5.23 5.23 0 0 0-1.279-3.434 9.768 9.768 0 0 1 6.963 6.963A5.23 5.23 0 0 0 16.5 7.5h-1.875a.375.375 0 0 1-.375-.375V5.25Z" />
        </symbol>
        <symbol id="icon-plus-circle" viewBox="0 0 24 24" fill="none">
            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 8V16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M8 12H16" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
        </symbol>
        <symbol id="icon-edit-03" viewBox="0 0 24 24" fill="currentColor">
            <path d="M21.731 2.269a2.625 2.625 0 0 0-3.712 0l-1.157 1.157 3.712 3.712 1.157-1.157a2.625 2.625 0 0 0 0-3.712ZM19.513 8.199l-3.712-3.712-8.4 8.4a5.25 5.25 0 0 0-1.32 2.214l-.8 2.685a.75.75 0 0 0 .933.933l2.685-.8a5.25 5.25 0 0 0 2.214-1.32l8.4-8.4Z" />
            <path d="M5.25 5.25a3 3 0 0 0-3 3v10.5a3 3 0 0 0 3 3h10.5a3 3 0 0 0 3-3V13.5a.75.75 0 0 0-1.5 0v5.25a1.5 1.5 0 0 1-1.5 1.5H5.25a1.5 1.5 0 0 1-1.5-1.5V8.25a1.5 1.5 0 0 1 1.5-1.5h5.25a.75.75 0 0 0 0-1.5H5.25Z" />
        </symbol>
    </svg>

    <div class="container">
        <header>
            <div class="page-header">
                <a href="index.html" class="action-btn" style="background-color: rgba(45, 45, 45, 0.9); color: var(--text-primary); margin-top: 0;">‚Üê Back</a>
                <h1>Manage Plan</h1>
                <div id="user-info" style="display: none; align-items: center; justify-content: center; gap: 10px;">
                    <img id="user-photo" style="width: 40px; height: 40px; border-radius: 50%;">
                </div>
            </div>
        </header>

        <div id="app-content" style="display: none;">
            <div id="main-content-wrapper" style="display: none;">
                <div id="ai-section" class="glass-card">
                    <div id="ai-section-header">
                        <h2>Transcribe Workout With AI</h2>
                        <img src="images/Rosecurve.png" id="ai-section-icon" alt="AI Icon">
                    </div>
                    <div id="ai-section-content">
                        <p style="color: var(--text-secondary); font-size: 0.9rem;">Get a free Google Gemini API key and upload a file containing a <b>single workout day</b>. The AI will automatically create a new plan for you.</p>
                        <div class="editor-form-group">
                            <label for="gemini-api-key">Google Gemini API Key (<a href="https://aistudio.google.com/app/apikey" target="_blank" style="color: var(--system-blue);">Get one here</a>)</label>
                            <input type="password" id="gemini-api-key" placeholder="Enter your API key">
                        </div>
                        <div class="editor-form-group">
                            <label for="ai-plan-name">New Plan Name</label>
                            <input type="text" id="ai-plan-name" placeholder="e.g., My Hypertrophy Push Day">
                        </div>
                        <div class="editor-form-group">
                            <label for="ai-file-input">Workout File</label>
                            <input type="file" id="ai-file-input" accept=".pdf,.txt,.csv,.md">
                        </div>
                        <button id="transcribe-btn" class="action-btn" style="width: 100%; background-color: var(--system-blue); color: var(--text-on-action);">
                            <span class="btn-text">Transcribe</span>
                            <div class="loader"></div>
                        </button>
                    </div>
                </div>

                <div id="schedule-section">
                    <h2>Weekly Schedule</h2>
                    <div id="schedule-list" class="glass-card" style="padding: 10px;"></div>
                </div>

                <div id="workouts-section" style="margin-top: 30px;">
                    <div class="page-header">
                        <h2>Workout Plans</h2>
                        <div>
                            <button id="import-workouts-btn" class="icon-btn" title="Import Plan">
                                <svg><use xlink:href="#icon-file-import"></use></svg>
                            </button>
                            <button id="add-workout-btn" class="action-btn" style="background-color: var(--system-blue); color: var(--text-on-action); margin-top: 0;">
                                <svg><use xlink:href="#icon-plus-circle"></use></svg>
                                <span>Workout</span>
                            </button>
                            <input type="file" id="import-file-input" accept=".json" style="display: none;">
                        </div>
                    </div>
                    <div id="workouts-list"></div>
                </div>
            </div>
            <div id="skeleton-loader">
                <div class="skeleton sk-ai-card"></div>
                <div class="skeleton-title skeleton"></div>
                <div class="skeleton sk-schedule-card">
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                    <div class="sk-schedule-item"><div class="skeleton sk-schedule-label"></div><div class="skeleton sk-schedule-select"></div></div>
                </div>
                <div class="sk-workouts-header">
                    <div class="skeleton-title skeleton"></div>
                    <div class="sk-workouts-buttons">
                        <div class="skeleton sk-button-icon"></div>
                        <div class="skeleton sk-button-main"></div>
                    </div>
                </div>
                <div class="skeleton sk-workout-item"></div>
                <div class="skeleton sk-workout-item"></div>
            </div>
        </div>
        <div id="sign-in-prompt" style="display: none; text-align: center; margin-top: 50px;">
            <h2>Please Sign In</h2>
            <p>You need to be signed in to manage your workout plan.</p>
            <a href="index.html" class="action-btn" style="background-color: var(--system-blue); color: var(--text-on-action);">Go to Sign In Page</a>
        </div>
    </div>

    <div class="modal-overlay" id="editor-overlay">
        <div class="overlay-content glass-card" id="editor-panel">
            <div class="overlay-header">
                <h2 id="editor-title">Edit Plan</h2>
                <button class="icon-btn" id="close-editor-btn"><svg><use xlink:href="#icon-close"></use></svg></button>
            </div>
            <div class="overlay-body" id="editor-exercises-list"></div>
            <div class="overlay-footer">
                <button class="action-btn" id="add-exercise-btn" style="background-color: rgba(255,255,255,0.1);">
                    <span class="btn-text">Add Exercise</span>
                </button>
                <button class="action-btn" id="save-workouts-btn" style="background-color: var(--system-blue); color: var(--text-on-action);">
                    <span class="btn-text">Save Changes</span>
                    <div class="loader"></div>
                </button>
            </div>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore-compat.js"></script>

    <script>
    const firebaseConfig = {
      apiKey: "AIzaSyDe-YVkiX81ISLhVfRdC0srkkHi2JQQeSs",
      authDomain: "my-fitness-tracker-797e5.firebaseapp.com",
      projectId: "my-fitness-tracker-797e5",
      storageBucket: "my-fitness-tracker-797e5.firebasestorage.app",
      messagingSenderId: "651004817600",
      appId: "1:651004817600:web:3a277ea0126dfe0388bd25"
    };

    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const db = firebase.firestore();
    let currentUser = null;
    let workouts = {};
    let schedule = {};

    const editorOverlay = document.getElementById('editor-overlay');
    const editorExercisesList = document.getElementById('editor-exercises-list');
    let editingWorkoutName = '';

    const mainContentWrapper = document.getElementById('main-content-wrapper');
    const skeletonLoader = document.getElementById('skeleton-loader');

    function showToast(message, type = 'info', duration = 3000) {
        const container = document.getElementById('toast-container');
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        container.appendChild(toast);
        setTimeout(() => {
            toast.classList.add('exiting');
            toast.addEventListener('animationend', () => toast.remove());
        }, duration);
    }

    function toggleButtonLoading(btn, isLoading) {
        btn.classList.toggle('loading', isLoading);
        btn.disabled = isLoading;
    }

    async function fetchData() {
        if (!currentUser) return;
        const userDoc = await db.collection('users').doc(currentUser.uid).get();
        const userData = userDoc.data() || {};
        workouts = userData.workouts || {};
        schedule = userData.schedule || {};
    }
//hello
    async function saveUserData(key, data) {
        if (!currentUser) return;
        try {
            await db.collection('users').doc(currentUser.uid).set({ [key]: data }, { merge: true });
            showToast('Changes saved successfully!', 'success');
        } catch (error) {
            showToast(`Error saving ${key}.`, 'error');
        }
    }

    function renderAll() {
        renderSchedule();
        renderWorkouts();
    }

    function renderSchedule() {
        const scheduleList = document.getElementById('schedule-list');
        scheduleList.innerHTML = '';
        const days = ["Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday"];
        days.forEach(day => {
            const dayKey = day.toLowerCase();
            const item = document.createElement('div');
            item.className = 'schedule-item';
            let optionsHTML = '<option value="Rest Day">Rest Day</option>';
            Object.keys(workouts).forEach(workoutName => {
                const selected = schedule[dayKey] === workoutName ? 'selected' : '';
                optionsHTML += `<option value="${workoutName}" ${selected}>${workoutName}</option>`;
            });
            item.innerHTML = `<label for="schedule-${dayKey}">${day}</label><select id="schedule-${dayKey}" data-day="${dayKey}">${optionsHTML}</select>`;
            scheduleList.appendChild(item);
            item.querySelector('select').addEventListener('change', async (e) => {
                schedule[e.target.dataset.day] = e.target.value;
                await saveUserData('schedule', schedule);
            });
        });
    }

    function renderWorkouts() {
        const workoutsList = document.getElementById('workouts-list');
        workoutsList.innerHTML = '';

        if (Object.keys(workouts).length === 0) {
            workoutsList.innerHTML = `<div class="glass-card" style="padding: 30px; text-align: center; margin-top: 10px;"><p style="margin: 0; color: var(--text-secondary); line-height: 1.5;">You don't have any plans yet. <br> Click 'Add Workout' or use the AI Transcriber to create your first one!</p></div>`;
            return;
        }

        Object.keys(workouts).forEach(name => {
            const item = document.createElement('div');
            item.className = 'workout-item glass-card';
            item.innerHTML = `<span class="workout-item-name">${name}</span>
                <div class="workout-item-actions">
                    <button class="icon-btn export-btn" data-name="${name}" title="Export Plan">
                        <svg><use xlink:href="#icon-share"></use></svg>
                    </button>
                    <button class="icon-btn edit-btn" data-name="${name}" title="Edit Plan">
                        <svg><use xlink:href="#icon-edit-03"></use></svg>
                    </button>
                    <button class="icon-btn delete-btn" data-name="${name}" title="Delete Plan">
                        <svg><use xlink:href="#icon-cancel-circle-sharp"></use></svg>
                    </button>
                </div>`;
            workoutsList.appendChild(item);
        });
        
        document.querySelectorAll('.export-btn').forEach(btn => {
            btn.addEventListener('click', (e) => {
                const workoutName = e.currentTarget.dataset.name;
                exportSingleWorkout(workoutName);
            });
        });
        document.querySelectorAll('.edit-btn').forEach(btn => btn.addEventListener('click', (e) => openEditor(e.currentTarget.dataset.name)));
        document.querySelectorAll('.delete-btn').forEach(btn => btn.addEventListener('click', (e) => deleteWorkout(e.currentTarget.dataset.name)));
    }

    document.getElementById('add-workout-btn').addEventListener('click', async () => {
        const name = prompt("Enter a name for the new workout plan:");
        if (name && !workouts[name]) {
            workouts[name] = [{ name: "", warmupSets: "", workingSets: "", reps: "", rest: "", earlySetRPE: "", lastSetRPE: "" }];
            await saveUserData('workouts', workouts);
            renderAll();
            openEditor(name);
        } else if (name) {
            showToast("A workout with this name already exists.", 'error');
        }
    });

    async function deleteWorkout(name) {
        if (confirm(`Are you sure you want to delete the workout plan "${name}"?`)) {
            if (!currentUser) { showToast("Not signed in.", "error"); return; }
            const batch = db.batch();
            const userRef = db.collection('users').doc(currentUser.uid);
            const workoutUpdate = { [`workouts.${name}`]: firebase.firestore.FieldValue.delete() };
            batch.update(userRef, workoutUpdate);
            const scheduleUpdate = {};
            let needsScheduleUpdate = false;
            for (const day in schedule) {
                if (schedule[day] === name) {
                    scheduleUpdate[`schedule.${day.toLowerCase()}`] = "Rest Day";
                    needsScheduleUpdate = true;
                }
            }
            if (needsScheduleUpdate) { batch.update(userRef, scheduleUpdate); }
            try {
                await batch.commit();
                delete workouts[name];
                for (const day in schedule) { if (schedule[day] === name) { schedule[day] = "Rest Day"; } }
                renderAll();
                showToast('Workout deleted successfully!', 'success');
            } catch (error) {
                console.error("Error deleting workout:", error);
                showToast('Failed to delete workout. Please try again.', 'error');
            }
        }
    }

    function openEditor(name) {
        editingWorkoutName = name;
        document.getElementById('editor-title').textContent = `Editing: ${name}`;
        editorExercisesList.innerHTML = '';
        workouts[name].forEach((ex, index) => editorExercisesList.appendChild(createExerciseEditorForm(ex, index)));
        editorOverlay.classList.add('active');
    }

    function closeEditor() {
        editorOverlay.classList.remove('active');
    }

    function createExerciseEditorForm(exercise, index) {
        const div = document.createElement('div');
        div.className = 'editor-exercise glass-card';
        div.dataset.index = index;
        const ex = { name: exercise.name || "", warmupSets: exercise.warmupSets || "", workingSets: exercise.workingSets || "", reps: exercise.reps || "", rest: exercise.rest || "", earlySetRPE: exercise.earlySetRPE || "", lastSetRPE: exercise.lastSetRPE || "" };
        div.innerHTML = `<div style="display: flex; justify-content: space-between; align-items: center;"><h4>Exercise ${index + 1}</h4><button class="icon-btn" onclick="this.parentElement.parentElement.remove()"><svg style="fill: var(--system-red);"><use xlink:href="#icon-close"></use></svg></button></div><div class="editor-form-group"><label>Name</label><input type="text" value="${ex.name}" data-key="name"></div><div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;"><div class="editor-form-group"><label>Warmup Sets</label><input type="number" value="${ex.warmupSets}" data-key="warmupSets"></div><div class="editor-form-group"><label>Working Sets</label><input type="number" value="${ex.workingSets}" data-key="workingSets"></div><div class="editor-form-group"><label>Reps</label><input type="text" value="${ex.reps}" data-key="reps"></div><div class="editor-form-group"><label>Rest (e.g., "90s" or "2 min")</label><input type="text" value="${ex.rest}" data-key="rest"></div><div class="editor-form-group"><label>Early RPE</label><input type="text" value="${ex.earlySetRPE}" data-key="earlySetRPE"></div><div class="editor-form-group"><label>Last RPE</label><input type="text" value="${ex.lastSetRPE}" data-key="lastSetRPE"></div></div>`;
        return div;
    }

    document.getElementById('add-exercise-btn').addEventListener('click', () => {
        const newExercise = { name: "", warmupSets: "", workingSets: "", reps: "", rest: "", earlySetRPE: "", lastSetRPE: "" };
        editorExercisesList.appendChild(createExerciseEditorForm(newExercise, editorExercisesList.children.length));
    });

    document.getElementById('save-workouts-btn').addEventListener('click', async () => {
        const btn = document.getElementById('save-workouts-btn');
        toggleButtonLoading(btn, true);
        const newWorkoutData = Array.from(document.querySelectorAll('#editor-exercises-list .editor-exercise')).map(form => {
            const exercise = {};
            form.querySelectorAll('input').forEach(input => { exercise[input.dataset.key] = input.type === 'number' ? parseInt(input.value, 10) || 0 : input.value; });
            return exercise;
        });
        workouts[editingWorkoutName] = newWorkoutData;
        await saveUserData('workouts', workouts);
        renderAll();
        toggleButtonLoading(btn, false);
        closeEditor();
    });

    document.getElementById('close-editor-btn').addEventListener('click', closeEditor);
    document.getElementById('ai-section-header').addEventListener('click', () => document.getElementById('ai-section').classList.toggle('expanded'));
    
    document.getElementById('transcribe-btn').addEventListener('click', async () => {
        const apiKey = document.getElementById('gemini-api-key').value;
        const file = document.getElementById('ai-file-input').files[0];
        const planName = document.getElementById('ai-plan-name').value.trim();
        if (!apiKey || !planName || !file) {
            showToast("Please fill out all AI fields.", "error");
            return;
        }
        if (workouts[planName]) {
            showToast(`Plan "${planName}" already exists.`, "error");
            return;
        }
        const btn = document.getElementById('transcribe-btn');
        toggleButtonLoading(btn, true);
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = async () => {
            const dataUrl = reader.result;
            const base64Data = dataUrl.substring(dataUrl.indexOf(',') + 1);
            const mimeType = dataUrl.substring(dataUrl.indexOf(':') + 1, dataUrl.indexOf(';'));
            try {
                const systemPrompt = `You are an expert fitness assistant. Your task is to analyze the provided user file and transcribe it into a structured JSON format. The output MUST be a single, valid JSON array of exercise objects. Your entire response must be only the JSON data. Do not include any text, explanations, or markdown formatting like \`\`\`json outside of the JSON array. Each exercise object in the array must have the following keys: "name", "warmupSets", "workingSets", "reps", "rest", "earlySetRPE", "lastSetRPE".
                            
Warm-up Sets Rule: For the "warmupSets" key, you must provide a single integer representing the *count* of warm-up sets listed for that exercise. For example, if the text says '2 warm-up sets' or lists two separate warm-up lines (e.g., 'Warm-up: 50lbs x 10, 70lbs x 5'), the value for "warmupSets" must be the number 2. If a range is provided (e.g., "1-2 warm-up sets"), you must always choose the lower number in the range (in this case, 1). If no warm-ups are mentioned, the value should be 0.

RPE Handling Rules: If no RPE is mentioned, set both "earlySetRPE" and "lastSetRPE" to an empty string "". If only ONE RPE value is mentioned (e.g., "RPE 8"), set BOTH "earlySetRPE" and "lastSetRPE" to that same value (e.g., "~8"). If two distinct RPEs are mentioned, assign them correctly. If a value is not present, use a sensible default or an empty string. Be intelligent about common abbreviations. Your entire response must be only the JSON data, starting with [ and ending with ].`;

                const requestBody = {
                    contents: [{
                        parts: [
                            { text: "Analyze the attached workout file and return only the JSON data." },
                            { inline_data: { mime_type: mimeType, data: base64Data } }
                        ]
                    }],
                    generationConfig: {
                        temperature: 0,
                        thinkingConfig: {
                            thinkingBudget: 8192
                        }
                    },
                    systemInstruction: {
                        parts: [
                            { text: systemPrompt }
                        ]
                    }
                };

                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    throw new Error(errorData.error.message || "API request failed.");
                }
                
                const data = await response.json();
                const rawText = data.candidates[0].content.parts[0].text;
                const jsonString = rawText.substring(rawText.indexOf('['), rawText.lastIndexOf(']') + 1);
                
                workouts[planName] = JSON.parse(jsonString);
                await saveUserData('workouts', workouts);
                renderAll();
                showToast(`Successfully added "${planName}"!`, 'success');
                document.getElementById('ai-plan-name').value = "";

            } catch (error) {
                showToast(`Error: ${error.message}`, 'error');
            } finally {
                toggleButtonLoading(btn, false);
            }
        };
        reader.onerror = () => {
            showToast("Error reading the file.", "error");
            toggleButtonLoading(btn, false);
        };
    });
    
    function exportSingleWorkout(name) {
        if (!workouts[name]) {
            showToast("Workout not found.", "error");
            return;
        }
        const workoutToExport = { [name]: workouts[name] };
        const dataStr = JSON.stringify(workoutToExport, null, 2);
        const dataBlob = new Blob([dataStr], {type: "application/json"});
        const url = URL.createObjectURL(dataBlob);
        const a = document.createElement('a');
        const safeName = name.replace(/[^a-z0-9]/gi, '_').toLowerCase();
        a.href = url;
        a.download = `workout_${safeName}.json`;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
        showToast(`Exported "${name}" successfully!`, "success");
    }

    async function handleWorkoutImport(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = async (e) => {
            try {
                const importedWorkouts = JSON.parse(e.target.result);
                if (typeof importedWorkouts !== 'object' || importedWorkouts === null) { throw new Error("Invalid JSON format."); }
                const updatedWorkouts = { ...workouts, ...importedWorkouts };
                workouts = updatedWorkouts;
                await saveUserData('workouts', workouts);
                renderAll();
                showToast("Workouts imported successfully!", "success");
            } catch (error) {
                showToast(`Import failed: ${error.message}`, "error");
            } finally {
                event.target.value = '';
            }
        };
        reader.onerror = () => showToast("Error reading the file.", "error");
        reader.readAsText(file);
    }

    document.getElementById('import-workouts-btn').addEventListener('click', () => {
        document.getElementById('import-file-input').click();
    });
    document.getElementById('import-file-input').addEventListener('change', handleWorkoutImport);

    async function initPageForUser() {
        await fetchData();
        renderAll();

        // All data is loaded and rendered, now switch visibility
        if (skeletonLoader && mainContentWrapper) {
            skeletonLoader.style.display = 'none';
            mainContentWrapper.style.display = 'block';
            mainContentWrapper.style.animation = 'fade-in 0.5s ease-out';
        }
    }

    auth.onAuthStateChanged(async user => {
        currentUser = user;
        const appContent = document.getElementById('app-content');
        const signInPrompt = document.getElementById('sign-in-prompt');
        const userInfoDiv = document.getElementById('user-info');
        if (user) {
            document.getElementById('user-photo').src = user.photoURL;
            appContent.style.display = 'block';
            signInPrompt.style.display = 'none';
            userInfoDiv.style.display = 'flex';

            // Ensure skeleton is visible and content is hidden before starting
            if (skeletonLoader && mainContentWrapper) {
                skeletonLoader.style.display = 'block';
                mainContentWrapper.style.display = 'none';
            }
            
            await initPageForUser();

        } else {
            appContent.style.display = 'none';
            signInPrompt.style.display = 'block';
            userInfoDiv.style.display = 'none';

            // Reset for next sign-in
            if (skeletonLoader && mainContentWrapper) {
                skeletonLoader.style.display = 'block';
                mainContentWrapper.style.display = 'none';
            }
        }
    });
    </script>
</body>
</html>
